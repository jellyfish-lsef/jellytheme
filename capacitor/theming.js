var defaultThemes = {
    default: {
        name: "Default",
        author: "theLMGN",
        vars: {
            "accent": "#4D9CF6",
            "background": "#202225",
            "background-2": "#222",
            "background-3": "#444",
            "text": "#fff",
            "text-on-accent": "#fff"
        },
        monacoTheme: {base:"vs-dark",inherit:true,rules:[{foreground:"5c6370",fontStyle:" italic",token:"comment"},{foreground:"b8cae8ff",token:"keyword.operator.class"},{foreground:"b8cae8ff",token:"constant.other"},{foreground:"b8cae8ff",token:"source.php.embedded.line"},{foreground:"fa6e7c",token:"variable"},{foreground:"fa6e7c",token:"support.other.variable"},{foreground:"fa6e7c",token:"string.other.link"},{foreground:"fa6e7c",token:"string.regexp"},{foreground:"fa6e7c",token:"entity.name.tag"},{foreground:"fa6e7c",token:"entity.other.attribute-name"},{foreground:"fa6e7c",token:"meta.tag"},{foreground:"fa6e7c",token:"declaration.tag"},{foreground:"eeb164ff",token:"constant.numeric"},{foreground:"eeb164ff",token:"constant.language"},{foreground:"eeb164ff",token:"support.constant"},{foreground:"eeb164ff",token:"constant.character"},{foreground:"eeb164ff",token:"variable.parameter"},{foreground:"eeb164ff",token:"punctuation.section.embedded"},{foreground:"eeb164ff",token:"keyword.other.unit"},{foreground:"eee280ff",token:"entity.name.class"},{foreground:"eee280ff",token:"entity.name.type.class"},{foreground:"eee280ff",token:"support.type"},{foreground:"eee280ff",token:"support.class"},{foreground:"adee7aff",token:"string"},{foreground:"adee7aff",token:"entity.other.inherited-class"},{foreground:"adee7aff",token:"markup.heading"},{foreground:"b8cae8ff",token:"constant.other.color"},{foreground:"61cbeeff",token:"entity.name.function"},{foreground:"61cbeeff",token:"meta.function-call"},{foreground:"61cbeeff",token:"support.function"},{foreground:"61cbeeff",token:"keyword.other.special-method"},{foreground:"61cbeeff",token:"meta.block-level"},{foreground:"ec7beeff",token:"keyword"},{foreground:"ec7beeff",token:"storage"},{foreground:"ec7beeff",token:"storage.type"},{foreground:"ec7beeff",token:"entity.name.tag.css"},{foreground:"ec7beeff",token:"keyword.operator"},{foreground:"eeeeeeff",background:"ee7c80ff",token:"invalid"},{foreground:"b8cae8ff",background:"6b4f4fff",token:"meta.separator"},{foreground:"243043ff",background:"ee864dff",token:"invalid.deprecated"},{foreground:"4fe1eeff",token:"constant.character"},{foreground:"4fe1eeff",token:"constant.other"}],colors:{"editor.foreground":"#BFCAE0","editor.background":"#202225","editor.selectionBackground":"#3D4350","editor.lineHighlightBackground":"#4C576730","editorCursor.foreground":"#528BFF","editorWhitespace.foreground":"#747369"}},
        customCSS: ""
    },
    "visualstudio_light.swmtheme": {
        "name": "Visual Studio Light",
        "author": "theLMGN",
        "isLight": true,
        "vars": {
            "accent": "#007ACC",
            "background": "#ffffff",
            "background-2": "#F3F3F3",
            "background-3": "#DDDDDD",
            "text": "#333333",
            "text-on-accent": "#fff"
        },
        "monacoTheme": "vs-light",
        "customCSS": ""
    },
    "visualstudio.swmtheme": {
        "name": "Visual Studio",
        "author": "theLMGN",
        "vars": {
            "accent": "#007ACC",
            "background": "#1E1E1E",
            "background-2": "#252526",  
            "background-3": "#333333",
            "text": "#D4D4D4",
            "text-on-accent": "#d4d4d4"
        },
        "monacoTheme": "vs-dark",
        "customCSS": ""
    },
    "hotdog.swmtheme": {
        "name": "Hotdog Stand",
        "author": "theLMGN",
        "vars": {
            "accent": "#ffff00",
            "background": "#ff0000",
            "background-2": "#ee0000",
            "background-3": "#aa0000",
            "text": "#fff",
            "text-on-accent": "#f00"
        },
        "monacoTheme": {
            "base": "vs-dark",
            "inherit": true,
            "rules": [
                {
                    "foreground": "000000",
                    "fontStyle": "italic",
                    "token": "comment"
                },
                {
                    "foreground": "ffff00",
                    "token": "keyword.operator.class"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.other"
                },
                {
                    "foreground": "ffff00",
                    "token": "source.php.embedded.line"
                },
                {
                    "foreground": "ffff00",
                    "token": "variable"
                },
                {
                    "foreground": "ffff00",
                    "token": "support.other.variable"
                },
                {
                    "foreground": "ffff00",
                    "token": "string.other.link"
                },
                {
                    "foreground": "ffff00",
                    "token": "string.regexp"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.name.tag"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.other.attribute-name"
                },
                {
                    "foreground": "ffff00",
                    "token": "meta.tag"
                },
                {
                    "foreground": "ffff00",
                    "token": "declaration.tag"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.numeric"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.language"
                },
                {
                    "foreground": "ffff00",
                    "token": "support.constant"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.character"
                },
                {
                    "foreground": "ffff00",
                    "token": "variable.parameter"
                },
                {
                    "foreground": "ffff00",
                    "token": "punctuation.section.embedded"
                },
                {
                    "foreground": "ffff00",
                    "token": "keyword.other.unit"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.name.class"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.name.type.class"
                },
                {
                    "foreground": "ffff00",
                    "token": "support.type"
                },
                {
                    "foreground": "ffff00",
                    "token": "support.class"
                },
                {
                    "foreground": "ffff00",
                    "token": "string"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.other.inherited-class"
                },
                {
                    "foreground": "ffff00",
                    "token": "markup.heading"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.other.color"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.name.function"
                },
                {
                    "foreground": "ffff00",
                    "token": "meta.function-call"
                },
                {
                    "foreground": "ffff00",
                    "token": "support.function"
                },
                {
                    "foreground": "ffff00",
                    "token": "keyword.other.special-method"
                },
                {
                    "foreground": "ffff00",
                    "token": "meta.block-level"
                },
                {
                    "foreground": "ffff00",
                    "token": "keyword"
                },
                {
                    "foreground": "ffff00",
                    "token": "storage"
                },
                {
                    "foreground": "ffff00",
                    "token": "storage.type"
                },
                {
                    "foreground": "ffff00",
                    "token": "entity.name.tag.css"
                },
                {
                    "foreground": "ffff00",
                    "token": "keyword.operator"
                },
                {
                    "foreground": "ffff00",
                    "token": "invalid"
                },
                {
                    "foreground": "ffff00",
                    "token": "meta.separator"
                },
                {
                    "foreground": "ffff00",
                    "token": "invalid.deprecated"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.character"
                },
                {
                    "foreground": "ffff00",
                    "token": "constant.other"
                }
            ],
            "colors": {
                "editor.foreground": "#000000",
                "editor.background": "#ff0000",
                "editor.selectionBackground": "#ffff00",
                "editor.lineHighlightBackground": "#ffff00",
                "editorCursor.foreground": "#ff0000",
                "editorWhitespace.foreground": "#ff0000",
                "minimapSlider.activeBackground": "#ff0000",
                "minimapSlider.background": "#ff0000",
                "minimapSlider.hoverBackground": "#ff0000"
            }
        },
        "customCSS": ""
    }
    
}
function searchForThemes() {
    if (!fs.existsSync(JELLYFISH_DATA_DIR)) {
        fs.mkdirSync(JELLYFISH_DATA_DIR)
    }
    if (!fs.existsSync(path.join(JELLYFISH_DATA_DIR,"Themes"))) {
        fs.mkdirSync(path.join(JELLYFISH_DATA_DIR,"Themes"))
        for (var theme in defaultThemes) {
            fs.writeFileSync(path.join(JELLYFISH_DATA_DIR,"Themes", theme.endsWith(".swmtheme") ? theme : (theme + ".swmtheme")),JSON.stringify(defaultThemes[theme],null,4))
        }
    }
    themeStore = {default: JSON.parse(JSON.stringify(defaultThemes.default))}
    var files = fs.readdirSync(path.join(JELLYFISH_DATA_DIR,"Themes"))
    for (var f of files) {
        try {
            if (f.startsWith(".") || !f.endsWith(".swmtheme") || f.includes("default")) continue;
            var p = JSON.parse(fs.readFileSync(path.join(JELLYFISH_DATA_DIR,"Themes",f)).toString())
            
            if (typeof p.name != "string") throw new Error("theme.name isn't a string")
            if (typeof p.author != "string") throw new Error("theme.author isn't a string")
            p.customCSS = p.customCSS || ""
            if (typeof p.customCSS != "string") throw new Error("theme.customCSS isn't a string")
            p.vars = p.vars || {}
            if (typeof p.vars != "object") throw new Error("theme.vars isn't a object")
            p.id = f
            themeStore[f] = p


        } catch(e) {
            console.error(e)
            (new Toast({
                title:"Couldn't load theme " + f,
                description: e.toString(),
                color: "error"
            })).show()
        }
    }
    for (var t in themeStore) {
        var theme = themeStore[t]
        var stacklen = 0;
        while (theme.base) {
            stacklen++;
            if (stacklen > 20) {
                (new Toast({
                    title:"Couldn't load theme " + t,
                    description: "Recursive base detected.",
                    color: "error"
                })).show()
                continue;
            }
            var b = theme.base
            theme.base = false
            if (themeStore[b]) {
                theme = Object.assign(Object.assign({},themeStore[b]),theme.base)
            }
        }
    }
}

var themeStore = {}
searchForThemes()
themeStore.default = JSON.parse(JSON.stringify(defaultThemes.default))
//console.log(themeStore,themeStore[localStorage.getItem("activeTheme")])

/**
 * Applies a theme to the current window
 * @param {Theme} theme The theme to apply
 */
function applyTheme(theme) {
    try {
        
        if (typeof theme.monacoTheme == "object") {
            monaco.editor.defineTheme("customTheme",theme.monacoTheme);
            monaco.editor.setTheme('customTheme');
        } else if (typeof theme.monacoTheme == "string"){
            monaco.editor.setTheme(theme.monacoTheme);
        } else {
            monaco.editor.setTheme("defaultTheme");
        }
        var s = "body {"
        for (var i in theme.vars) {
            s += "  --" + i + ": " + theme.vars[i] + ";\n"
        }
        s += "}\n\n"
        if (theme.isLight) {
            for (var image of document.querySelectorAll("[src='assets/img/logo.png']")) {
                image.src = "assets/img/logo_dark.png"
            }
            s += "#aboutBtn {filter: grayscale(100%) brightness(0%);}"
        } else {
            for (var image of document.querySelectorAll("[src='assets/img/logo_dark.png']")) {
                image.src = "assets/img/logo.png"
            }
        }
        s += theme.customCSS
        document.querySelector("#themeApplication").innerHTML = s
        localStorage.setItem("activeTheme",theme.id)
    } catch(e) {
        console.error(e)
        (new Toast({
            title:"Theme failed to apply",
            description: e.toString(),
            color: "error"
        })).show()
        monaco.editor.setTheme('defaultTheme');
        document.querySelector("#themeApplication").innerHTML = ""
    }
}
window.addEventListener("load",async ()=> {
    await monacoLoaded
    applyTheme(themeStore[localStorage.getItem("activeTheme")] || themeStore.default)
})
/**
 * Updates the script selection on the options page
 */
function updateThemes() {
    

    var parent = document.querySelector("#aboutPageThemes")
    parent.innerHTML = ""
    searchForThemes()
    for (var t in themeStore) {
        ;(function() {
            var theme = themeStore[t]
            var tp = document.createElement("a")
            tp.className = "themePreview"
            var s = ""
            for (var i in theme.vars) {
                s += "--" + i + ": " + theme.vars[i] + ";\n"
            }
            tp.style = s
            var themeHeader = document.createElement("b")
            themeHeader.innerText = theme.name
            tp.appendChild(themeHeader)
            var themeSubtitle = document.createElement("p")
            themeSubtitle.innerText = theme.author
            tp.appendChild(themeSubtitle)
            tp.onclick = () => {
                applyTheme(theme)
            }
            parent.appendChild(tp)
        })()
    }
}
updateThemes()